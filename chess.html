<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Web Chess Board</title>
<link rel="stylesheet" href="style.css" />
<style>
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
}
#grid {
  display: grid;
  grid-template-columns: auto;
}
@media only screen and (min-width: 600px) {
  #grid {
    grid-template-columns: auto auto auto;
  }
}
@media only screen and (max-width: 600px) {
  #grid > div:nth-child(3) {
    max-height: calc(100vh - 100vmin);
    overflow-y: auto;
  }
}
</style>
</head>
<body>
<div id="grid">
  <div></div>
  <div style="position: relative; max-height: 100vh;">
    <table class="chess-container">
      <tr><td data-index="0"></td><td data-index="1"></td><td data-index="2"></td><td data-index="3"></td><td data-index="4"></td><td data-index="5"></td><td data-index="6"></td><td data-index="7"></td></tr>
      <tr><td data-index="8"></td><td data-index="9"></td><td data-index="10"></td><td data-index="11"></td><td data-index="12"></td><td data-index="13"></td><td data-index="14"></td><td data-index="15"></td></tr>
      <tr><td data-index="16"></td><td data-index="17"></td><td data-index="18"></td><td data-index="19"></td><td data-index="20"></td><td data-index="21"></td><td data-index="22"></td><td data-index="23"></td></tr>
      <tr><td data-index="24"></td><td data-index="25"></td><td data-index="26"></td><td data-index="27"></td><td data-index="28"></td><td data-index="29"></td><td data-index="30"></td><td data-index="31"></td></tr>
      <tr><td data-index="32"></td><td data-index="33"></td><td data-index="34"></td><td data-index="35"></td><td data-index="36"></td><td data-index="37"></td><td data-index="38"></td><td data-index="39"></td></tr>
      <tr><td data-index="40"></td><td data-index="41"></td><td data-index="42"></td><td data-index="43"></td><td data-index="44"></td><td data-index="45"></td><td data-index="46"></td><td data-index="47"></td></tr>
      <tr><td data-index="48"></td><td data-index="49"></td><td data-index="50"></td><td data-index="51"></td><td data-index="52"></td><td data-index="53"></td><td data-index="54"></td><td data-index="55"></td></tr>
      <tr><td data-index="56"></td><td data-index="57"></td><td data-index="58"></td><td data-index="59"></td><td data-index="60"></td><td data-index="61"></td><td data-index="62"></td><td data-index="63"></td></tr>
    </table>
    <img src="data:image/gif;base64,R0lGODlhmwCbAHAAACH5BAEAAAEALAAAAACbAJsAgQAAAAAAAAAAAAAAAAJ9jI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8fyTNf2jef6zvf+DwwKh8Si8YhMKpfMpvMJjUqn1Kr1is1qt9yu9wsOi8fksvmMTqvX7Lb7DY/L5/S6/Y7P6/f8vv8PGCg4SFhoeIiYqLjI2Oj4CBkpOUlZaXmJmam5ydlA6fkJGio6SlpqeoqaqrrK2ur6ChsrO0tba3uLm6u7y9vr+wscLDxMXGx8jJysvMzc7PwMHS09TV1tfY2drb3N3QTt7VkAADs=" id="board-background" style="display: none; max-height: 100vmin;" />
    <div class="coords ranks">
      <span>1</span>
      <span>2</span>
      <span>3</span>
      <span>4</span>
      <span>5</span>
      <span>6</span>
      <span>7</span>
      <span>8</span>
    </div>
    <div class="coords files">
      <span>a</span>
      <span>b</span>
      <span>c</span>
      <span>d</span>
      <span>e</span>
      <span>f</span>
      <span>g</span>
      <span>h</span>
    </div>
  </div>
  <div>
    <div>
      <label for="load-record">Load chess record file:</label>
      <input type="file" id="load-record" />
    </div>
    <div>
      <label for="load-engine">Load WASM UCI engine:</label>
      <input type="file" id="load-engine" />
    </div>
    <div>
      <label for="game-select">Select game from file:</label>
      <select id="game-select"></select>
    </div>
    <hr />
      <p>Current mode:</p>
      <input type="radio" id="btn-viewmode" name="mode" checked />
      <label for="btn-viewmode">View</label>
      <input type="radio" id="btn-editmode" name="mode" />
      <label for="btn-editmode">Edit</label>
      <input type="radio" id="btn-matchmode" name="mode" />
      <label for="btn-matchmode">Match</label>
    <hr />
    <div id="edit-mode-piece-select" style="display: none;">
      <div id="piece-selector">
        <img src="img/Chess_Pieces_Sprite.svg" style="max-width: 100%;" />
        <br />
        <button id="erase-piece" style="background-color: transparent; border: 0; padding: 0; font-size: 2.5em;">üóëÔ∏è<!-- ü™å --></button>
      </div>
      <br />
      <button id="restore-startpos">Restore to start position</button>
      <button id="empty-board">Empty the board</button>
      <hr />
    </div>
    <button id="btn-previous">‚Üê</button>
    &#32;
    <span id="step-indicator"><input type="number" id="step-count" value="0" min="0" max="999" />/<span id="step-total">0</span></span>
    &#32;
    <button id="btn-next">‚Üí</button>
    <div class="popup">
      <button id="image-capture-btn">Capture Image</button>
      <span class="popuptext-below" id="image-capture-popup">Image written to clipboard</span>
    </div>
    <hr />
    <p>Display settings:</p>
    <div>
      <p>Board colour scheme:</p>
      <div class="color-scheme-preset" data-light="#f1d9c0" data-dark="#a97a65">
        <span class="color-box" style="background-color: #f1d9c0;">„ÄÄ</span><span class="color-box" style="background-color: #a97a65;">„ÄÄ</span>
      </div>
      <div class="color-scheme-preset" data-light="#eceed1" data-dark="#769b44">
        <span class="color-box" style="background-color: #eceed1;">„ÄÄ</span><span class="color-box" style="background-color: #769b44;">„ÄÄ</span>
      </div>
      <div class="color-scheme-preset" data-light="#dfe2e7" data-dark="#8ca0af">
        <span class="color-box" style="background-color: #dfe2e7;">„ÄÄ</span><span class="color-box" style="background-color: #8ca0af;">„ÄÄ</span>
      </div>
      <div class="color-scheme-preset" data-light="#484073" data-dark="#170a2f">
        <span class="color-box" style="background-color: #484073;">„ÄÄ</span><span class="color-box" style="background-color: #170a2f;">„ÄÄ</span>
      </div>
      <div class="color-scheme-preset" data-light="#cccccc" data-dark="#aaaaaa">
        <span class="color-box" style="background-color: #cccccc;">„ÄÄ</span><span class="color-box" style="background-color: #aaaaaa;">„ÄÄ</span>
      </div>
      <input type="color" id="color-picker-light" class="color-picker" value="#f1d9c0" />
      <input type="color" id="color-picker-dark" class="color-picker" value="#a97a65" />
    </div>
    <div>
      <input type="checkbox" id="rotate-board" />
      <label for="rotate-board">Rotate board (view from black‚Äôs perspective)</label>
    </div>
    <div>
      <input type="checkbox" id="hide-pieces" />
      <label for="hide-pieces">Hide pieces</label>
    </div>
    <div>
      <input type="checkbox" id="hide-last-move" />
      <label for="hide-last-move">Hide last move marker</label>
    </div>
    <div>
      <input type="checkbox" id="hide-check" />
      <label for="hide-check">Hide check marker</label>
    </div>
    <hr />
    <div>
      <label for="textbox-fen">FEN string of current position:</label>
      <input type="text" id="textbox-fen" value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1" />
      <div class="popup" style="display: inline;">
        <button id="fen-copy-btn">Copy FEN string</button>
        <span class="popuptext-below" id="fen-copy-popup">String copied</span>
      </div>
      <button id="btn-import-fen">Load FEN string</button>
    </div>
    <div>
      <label for="textbox-b64pos">Custom base64 position format:</label>
      <input type="text" id="textbox-b64pos" />
      <div class="popup" style="display: inline;">
        <button id="b64pos-copy-btn">Copy base64 position</button>
        <span class="popuptext-below" id="b64pos-copy-popup">String copied</span>
      </div>
      <button id="btn-import-b64pos">Load base64 position</button>
    </div>
    <div>
      <div class="popup" style="display: inline;">
        <button id="textboard-copy-btn">Copy textual board</button>
        <span class="popuptext-below" id="textboard-copy-popup">String copied</span>
      </div>
    </div>
    <div>
      <label for="textbox-b64moves">Base64 move notation:</label>
      <input type="text" id="textbox-b64moves" />
      <div class="popup" style="display: inline;">
        <button id="b64moves-copy-btn">Copy base64 moves</button>
        <span class="popuptext-below" id="b64moves-copy-popup">String copied</span>
      </div>
      <button id="btn-import-b64moves">Parse base64 moves</button>
    </div>
    <div>
      <label for="textbox-ucimoves">UCI move notation:</label>
      <input type="text" id="textbox-ucimoves" />
      <div class="popup" style="display: inline;">
        <button id="ucimoves-copy-btn">Copy UCI moves</button>
        <span class="popuptext-below" id="ucimoves-copy-popup">String copied</span>
      </div>
      <button id="btn-import-ucimoves">Parse UCI moves</button>
    </div>
    <hr />
    <p>Game state:</p>
    <div>
      <span id="side-to-move">Side to move:</span>
      <input type="radio" id="black-to-move" name="side-to-move" disabled />
      <label for="black-to-move">Black</label>
      <input type="radio" id="white-to-move" name="side-to-move" disabled />
      <label for="white-to-move">White</label>
    </div>
    <div>
      White castling right:
      <br />
      <label for="castling-right-white-short">Short (O-O)</label>
      <input type="checkbox" id="castling-right-white-short" disabled />
      <label for="castling-right-white-long">Long (O-O-O)</label>
      <input type="checkbox" id="castling-right-white-long" disabled />
    </div>
    <div>
      Black castling right:
      <br />
      <label for="castling-right-black-short">Short (O-O)</label>
      <input type="checkbox" id="castling-right-black-short" disabled />
      <label for="castling-right-wblack-long">Long (O-O-O)</label>
      <input type="checkbox" id="castling-right-black-long" disabled />
    </div>
    <div>
      <label for="ep-target">En passant target square:</label>
      <input type="text" id="ep-target" disabled />
    </div>
    <hr />
    <div>
      <p>Comments:</p>
      <textarea id="textbox-comments"></textarea>
    </div>
    <hr />
    <p style="text-align: center;">
      <a href="/docs/boardgame/chess.html">Help</a>
      &nbsp;¬∑&nbsp;
      <a href="index.html">Return to Homepage</a>
    </p>
  </div>
</div>
<script src="chess.js"></script>
<script type="text/javascript">
"use strict";

let sleep = async function (ms) {
  return new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
};

let boardEl = document.querySelector("table.chess-container tbody");
let board = new Board();
let currentMode = 0; // 0: view, 1: edit, 2: match
let currentPickedPiece = 14;
let boardRotated = false;

board.fillGameStates = function () {
  if (this.isWhiteToMove) {
    document.getElementById("white-to-move").checked = true;
    document.getElementById("black-to-move").checked = false;
  } else {
    document.getElementById("white-to-move").checked = false;
    document.getElementById("black-to-move").checked = true;
  };
  document.getElementById("step-count").value = this.plyCount;
};

const boardEdit = function (ev) {
  const grid = ev.target;
  const { index } = ev.target.dataset;

  // Put/erase the piece onto the board object
  if (boardRotated) {
    board.setPiece(63 - index, currentPickedPiece);
  } else {
    board.setPiece(index, currentPickedPiece);
  };

  // Recalculate the textual boards
  document.getElementById("textbox-fen").value = board.getFENString();
  document.getElementById("textbox-b64pos").value = board.toBase64String();
  board.drawBoard(boardEl, boardRotated);
};

const boardMatch = function (ev) {};

boardEl.addEventListener("click", (ev) => {
  const td = ev.target.closest("td");
  if (!td || currentMode === 0) return;

  // Route to the correct function based on mode
  if (currentMode === 1) { // edit mode
    boardEdit.call(td, ev); // .call(td) preserves the 'this' context if needed
  } else if (currentMode === 2) { // match mode
    boardMatch.call(td, ev);
  };
});

const setMode = function (mode) {
  currentMode = mode;
  boardEl.className = `mode-${mode}`;
};

document.getElementById("load-record").addEventListener("input", (ev) => {
  const file = ev.target.files[0];
  switch (file.type) {
    case "application/x-chess-pgn":
      break;
    default: // interpret as custom format
      break;
  };
});

const toggleEditModeButtons = function (enabled) {
  const disabled = !enabled;

  document.getElementById("edit-mode-piece-select").style.display = enabled ? "block" : "none";
  document.getElementById("black-to-move").disabled = disabled;
  document.getElementById("white-to-move").disabled = disabled;
  document.getElementById("castling-right-white-short").disabled = disabled;
  document.getElementById("castling-right-white-long").disabled = disabled;
  document.getElementById("castling-right-black-short").disabled = disabled;
  document.getElementById("castling-right-black-long").disabled = disabled;
  document.getElementById("ep-target").disabled = disabled;
};

document.getElementById("btn-viewmode").addEventListener("input", () => {
  toggleEditModeButtons(false);
  setMode(0);
});

document.getElementById("btn-editmode").addEventListener("input", () => {
  toggleEditModeButtons(true);
  setMode(1);
});

document.getElementById("btn-matchmode").addEventListener("input", () => {
  toggleEditModeButtons(false);
  setMode(2);
});

document.querySelector("#piece-selector img").addEventListener("click", (ev) => {
  const rect = ev.target.getBoundingClientRect();
  // Calculate the position relative to the image (in pixels)
  const x = ev.clientX - rect.left;
  const y = ev.clientY - rect.top;
  // Calculate the relative coordinates (0.0 to 1.0)
  const xPercent = x / rect.width;
  const yPercent = y / rect.height;
  
  currentPickedPiece = parseInt(xPercent * 6) + parseInt(yPercent * 2) * 8 + 9;
  // console.info(currentPickedPiece, xPercent, yPercent);

  // Switch rook and bishop
  if ((currentPickedPiece & 7) == Piece.ROOK) {
    currentPickedPiece = (currentPickedPiece & 24) | Piece.BISHOP;
  } else if ((currentPickedPiece & 7) == Piece.BISHOP) {
    currentPickedPiece = (currentPickedPiece & 24) | Piece.ROOK;
  };

  document.getElementById("erase-piece").style.border = "0";
});

document.getElementById("erase-piece").addEventListener("click", (ev) => {
  currentPickedPiece = 0;
  ev.target.style.border = "3px solid red";
});

document.getElementById("restore-startpos").addEventListener("click", () => {
  document.getElementById("textbox-b64pos").value = "vNqdy+7u7u4AAAAAAAAAAAAAAAAAAAAAZmZmZjRSFUM";
  document.getElementById("btn-import-b64pos").click();
});

document.getElementById("empty-board").addEventListener("click", () => {
  document.getElementById("textbox-b64pos").value = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
  document.getElementById("btn-import-b64pos").click();
});

document.getElementById("step-count").addEventListener("input", (ev) => {
  if (currentMode === 1) {
    board.plyCount = ev.target.value;

    // Recalculate the textual boards
    document.getElementById("textbox-fen").value = board.getFENString();
    document.getElementById("textbox-b64pos").value = board.toBase64String();
  };
});

document.getElementById("image-capture-btn").addEventListener("click", async () => {
  let blob = await board.getImage();
  await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
  document.getElementById("image-capture-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("image-capture-popup").classList.toggle("show");
  }, 5000);
});

document.querySelectorAll(".color-scheme-preset").forEach((e) => {
  e.addEventListener("click", (ev) => {
    const { light, dark } = ev.target.closest(".color-scheme-preset").dataset;
    boardEl.parentElement.style.cssText = `--chess-board-light: ${light}; --chess-board-dark: ${dark};`;
  });
});

document.getElementById("color-picker-light").addEventListener("input", (ev) => {
  boardEl.parentElement.style.setProperty('--chess-board-light', ev.target.value);
});

document.getElementById("color-picker-dark").addEventListener("input", (ev) => {
  boardEl.parentElement.style.setProperty('--chess-board-dark', ev.target.value);
});

document.getElementById("rotate-board").addEventListener("input", (ev) => {
  boardRotated = !boardRotated;
  board.drawBoard(boardEl, boardRotated);
});

document.getElementById("fen-copy-btn").addEventListener("click", async () => {
  await navigator.clipboard.writeText(document.getElementById("textbox-fen").value);
  document.getElementById("fen-copy-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("fen-copy-popup").classList.toggle("show");
  }, 5000);
});

document.getElementById("btn-import-fen").addEventListener("click", () => {
  board.importFromFen(document.getElementById("textbox-fen").value);
  document.getElementById("textbox-b64pos").value = board.toBase64String();
  board.drawBoard(boardEl, boardRotated);
  board.fillGameStates();
});

document.getElementById("b64pos-copy-btn").addEventListener("click", async () => {
  await navigator.clipboard.writeText(document.getElementById("textbox-b64pos").value);
  document.getElementById("b64pos-copy-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("b64pos-copy-popup").classList.toggle("show");
  }, 5000);
});

document.getElementById("btn-import-b64pos").addEventListener("click", () => {
  board.importFromBase64(document.getElementById("textbox-b64pos").value);
  document.getElementById("textbox-fen").value = board.getFENString();
  board.drawBoard(boardEl, boardRotated);
  board.fillGameStates();
});

document.getElementById("textboard-copy-btn").addEventListener("click", async () => {
  await navigator.clipboard.writeText(board.toString());
  document.getElementById("textboard-copy-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("textboard-copy-popup").classList.toggle("show");
  }, 5000);
});

document.getElementById("btn-import-b64moves").addEventListener("click", () => {
  board.parseBase64Moves(document.getElementById("textbox-b64moves").value);

  document.getElementById("textbox-ucimoves").value = board.toUCIMoves();
});

document.getElementById("b64moves-copy-btn").addEventListener("click", async () => {
  await navigator.clipboard.writeText(document.getElementById("textbox-b64moves").value);
  document.getElementById("b64moves-copy-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("b64moves-copy-popup").classList.toggle("show");
  }, 5000);
});

document.getElementById("btn-import-ucimoves").addEventListener("click", () => {
  board.parseUCIMoves(document.getElementById("textbox-ucimoves").value);

  document.getElementById("textbox-b64moves").value = board.toBase64Moves();
});

document.getElementById("ucimoves-copy-btn").addEventListener("click", async () => {
  await navigator.clipboard.writeText(document.getElementById("textbox-ucimoves").value);
  document.getElementById("ucimoves-copy-popup").classList.toggle("show");
  setTimeout(() => {
    document.getElementById("ucimoves-copy-popup").classList.toggle("show");
  }, 5000);
});

document.getElementById("black-to-move").addEventListener("input", () => {
  if (currentMode)
    board.isWhiteToMove = false;

    if (currentMode === 2) {
      // Recalculate the textual boards
      document.getElementById("textbox-fen").value = board.getFENString();
      document.getElementById("textbox-b64pos").value = board.toBase64String();
    };
});

document.getElementById("white-to-move").addEventListener("input", () => {
  if (currentMode)
    board.isWhiteToMove = true;

    if (currentMode === 2) {
      // Recalculate the textual boards
      document.getElementById("textbox-fen").value = board.getFENString();
      document.getElementById("textbox-b64pos").value = board.toBase64String();
    };
});

const params = new URL(location.href).searchParams;

if (params.get("fen")) {
  document.getElementById("textbox-fen").value = params.get("fen");
};

if (params.get("b64pos")) {
  document.getElementById("textbox-b64pos").value = params.get("b64pos");
  (async () => {
    await sleep(500);
    document.getElementById("btn-import-b64pos").click();
  })();
};

if (params.size === 0 || params.get("fen")) {
  (async () => {
    await sleep(500);
    document.getElementById("btn-import-fen").click();
  })();
};
</script>
</body>
</html>
